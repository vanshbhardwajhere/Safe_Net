{% extends "base.html" %}
{% block content %}
<h2>Flagged Comments</h2>
{% if user.role in 'admin,moderator' %}
  <div class="alert alert-info">
    <strong>Moderator Panel:</strong> Review and approve/reject flagged content below.
  </div>
{% endif %}

<ul class="list-group">
  {% for item in flagged %}
    <li class="list-group-item">
      <div class="d-flex justify-content-between align-items-start">
        <div class="flex-grow-1">
          <strong>{{ item.user.username }}</strong>: {{ item.text }}
          <div class="text-muted small">
            Posted {{ item.created_at }} | 
            Status: <span class="badge bg-warning">{{ item.status|title }}</span>
            {% if item.moderation_results.first %}
              | Label: <span class="badge bg-secondary">{{ item.moderation_results.first.label|title }}</span>
              | Confidence: {{ item.moderation_results.first.confidence_score|floatformat:2 }}
            {% endif %}
          </div>
        </div>
        <div class="btn-group" role="group">
          {% if user.role in 'admin,moderator' %}
            <a class="btn btn-sm btn-outline-primary" href="{% url 'review_content' item.id %}">
              <i class="bi bi-eye"></i> Review
            </a>
            <button class="btn btn-sm btn-success quick-approve" data-content-id="{{ item.id }}">
              <i class="bi bi-check"></i> Approve
            </button>
            <button class="btn btn-sm btn-danger quick-reject" data-content-id="{{ item.id }}">
              <i class="bi bi-x"></i> Reject
            </button>
          {% else %}
            <span class="text-muted small">Awaiting moderator review</span>
          {% endif %}
        </div>
      </div>
    </li>
  {% empty %}
    <li class="list-group-item">No flagged comments.</li>
  {% endfor %}
</ul>

{% if user.role in 'admin,moderator' %}
{% csrf_token %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Quick approve functionality
    document.querySelectorAll('.quick-approve').forEach(button => {
        button.addEventListener('click', function() {
            const contentId = this.dataset.contentId;
            if (confirm('Are you sure you want to approve this content?')) {
                fetch(`/moderation/quick-review/${contentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=approve'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'approved') {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error approving content');
                });
            }
        });
    });

    // Quick reject functionality
    document.querySelectorAll('.quick-reject').forEach(button => {
        button.addEventListener('click', function() {
            const contentId = this.dataset.contentId;
            if (confirm('Are you sure you want to reject this content?')) {
                fetch(`/moderation/quick-review/${contentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'action=reject'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'rejected') {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error rejecting content');
                });
            }
        });
    });
});
</script>
{% endif %}
{% endblock %}

